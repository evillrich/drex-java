{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Drex Position Metadata Schema",
  "description": "Schema for position metadata generated by Drex pattern extraction, mapping JSON paths to source document locations",
  "type": "object",
  "patternProperties": {
    "^[a-zA-Z_][a-zA-Z0-9_]*": {
      "$ref": "#/$defs/positionInfo"
    },
    "^\\$\\.[a-zA-Z_][a-zA-Z0-9_.\\[\\]]*": {
      "$ref": "#/$defs/positionInfo"
    }
  },
  "additionalProperties": false,
  "$defs": {
    "positionInfo": {
      "type": "object",
      "properties": {
        "textBounds": {
          "$ref": "#/$defs/textBounds",
          "description": "Position information for plain text input"
        },
        "spatialBounds": {
          "$ref": "#/$defs/spatialBounds",
          "description": "Position information for OCR/image input"
        },
        "originalText": {
          "type": "string",
          "description": "The original text as it appeared in the source document"
        },
        "formattedText": {
          "type": "string",
          "description": "The text after applying format function transformations"
        },
        "characterBounds": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/characterPosition"
          },
          "description": "Character-level position data for OCR inputs (optional)"
        }
      },
      "required": ["originalText", "formattedText"],
      "oneOf": [
        {"required": ["textBounds"]},
        {"required": ["spatialBounds"]}
      ],
      "additionalProperties": false
    },
    "textBounds": {
      "type": "object",
      "description": "Position bounds for plain text input using line/character coordinates",
      "properties": {
        "line": {
          "type": "integer",
          "minimum": 1,
          "description": "Line number (1-indexed)"
        },
        "start": {
          "type": "integer",
          "minimum": 0,
          "description": "Starting character position within the line (0-indexed)"
        },
        "end": {
          "type": "integer",
          "minimum": 0,
          "description": "Ending character position within the line (0-indexed, exclusive)"
        }
      },
      "required": ["line", "start", "end"],
      "additionalProperties": false
    },
    "spatialBounds": {
      "type": "object",
      "description": "Position bounds for OCR/image input using x,y coordinates",
      "properties": {
        "x": {
          "type": "number",
          "description": "Left edge coordinate"
        },
        "y": {
          "type": "number",
          "description": "Top edge coordinate"
        },
        "width": {
          "type": "number",
          "minimum": 0,
          "description": "Width of the bounding box"
        },
        "height": {
          "type": "number",
          "minimum": 0,
          "description": "Height of the bounding box"
        }
      },
      "required": ["x", "y", "width", "height"],
      "additionalProperties": false
    },
    "characterPosition": {
      "type": "object",
      "description": "Individual character position and confidence for OCR inputs",
      "properties": {
        "char": {
          "type": "string",
          "maxLength": 1,
          "description": "The character"
        },
        "x": {
          "type": "number",
          "description": "Character x coordinate"
        },
        "y": {
          "type": "number",
          "description": "Character y coordinate"
        },
        "width": {
          "type": "number",
          "minimum": 0,
          "description": "Character width"
        },
        "height": {
          "type": "number",
          "minimum": 0,
          "description": "Character height"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "OCR confidence score for this character"
        }
      },
      "required": ["char", "x", "y", "width", "height"],
      "additionalProperties": false
    }
  }
}